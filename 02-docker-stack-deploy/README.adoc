= Deploy docker stack to swarm cluster

in progres...

.clone app for stack deploy demo
[source,bash]
----
git clone https://github.com/daggerok/parse-server-example.git app-stack
cd app-stack
git reset --hard f35790c00cdf820c79f389fd587fba20c44b844d
yarn -i
----

.create requirements.txt file with content
[source,bash]
----
mongo
mongo-express
----

.create server ./Dockerfile file with content
[source,Dockerfile]
----
FROM node:8.5.0-alpine
ADD . /app
WORKDIR /app
CMD ["node", "index.js"]
----

.create client ./app./Dockerfile file with content
[source,Dockerfile]
----
FROM nginx:1.13.5-alpine
ADD ./app /usr/share/nginx/html
----

.edit ./docker-compose-all.yml file (set version: 3)
[source,docker-compose.yml]
----
version: "3"
services:
  mongo:
    restart: always
    image: healthcheck/mongo:latest
    ports: ["27017:27017"]
    networks: [backing-services]
    volumes: ["mongo-data:/data/db"]
    environment:
      # MONGO_PORT_27017_TCP_ADDR: "localhost"
      MONGO_PORT_27017_TCP_PORT: 27017
  mongo-express:
    restart: always
    depends_on: [mongo]
    image: mongo-express:0.42
    ports: ["8081:8081"]
    networks: [backing-services]
    environment:
      ME_CONFIG_MONGODB_ENABLE_ADMIN: "true"
      ME_CONFIG_OPTIONS_EDITORTHEME: "ambiance"
      ME_CONFIG_MONGODB_PORT: 27017
      ME_CONFIG_MONGODB_SERVER: "mongo"
  parse-server-app:
    restart: always
    image: node:8.5.0-alpine
    depends_on: [mongo]
    ports: ["1337:1337"]
    networks: [backing-services]
    volumes:
      - "parse-server-app-data:/app"
      - ".:/app"
    working_dir: /app
    environment:
      MONGODB_URI: "mongodb://mongo:27017/dev"
    entrypoint: sh -c "node ./index.js"
  parse-client-app:
    restart: always
    image: nginx:1.13.5-alpine
    depends_on: [parse-server-app]
    ports: ["80:80"]
    networks: [backing-services]
    volumes:
      - "parse-client-app-data:/var/log/nginx"
      - "./app:/usr/share/nginx/html:ro"
volumes:
  mongo-data: {}
  parse-server-app-data: {}
  parse-client-app-data: {}
networks:
  backing-services:
    driver: bridge
----

.bootstrap all
[source,bash]
----
docker-compose -f docker-compose-all-v3.yml up
----

.check deployments
[source,bash]
----
http :8081
http :1337
http :80
----

.stop and remove volumes
[source,bash]
----
docker-compose -f docker-compose-all-v3.yml down --volumes
----

.initialize docker swarm cluster
[source,bash]
----
docker swarm init                                                                      15:30:11
Swarm initialized: current node (v8dubeou5jz60yieigxu8rh8p) is now a manager.

To add a worker to this swarm, run the following command:

    docker swarm join --token SWMTKN-1-2g0xctse6vv7vmeaa5reast7ajmgicxwahd6lg6c35jzknp1eb-1da7gghwm68cngrfrlkzkxz2n 192.168.65.2:2377

To add a manager to this swarm, run 'docker swarm join-token manager' and follow the instructions.

docker node ls
ID                            HOSTNAME            STATUS              AVAILABILITY        MANAGER STATUS
2id006r5r6boesrvtexlgvn4z *   moby                Ready               Active              Leader
----

.add docker service registery as a service
[source,bash]
----
docker service create --name registry --publish 5000:5000 registry:2
2g1qzxk4uo98akb4f29m4e6ox
Since --detach=false was not specified, tasks will be created in the background.
In a future release, --detach=false will become the default.

docker service ls

ID                  NAME                MODE                REPLICAS            IMAGE               PORTS
2g1qzxk4uo98        registry            replicated          1/1                 registry:2          *:5000->5000/tcp

curl http://localhost:5000/v2/                                                                                  22:38:20
{}
----

.add docker service registery as a service
[source,bash]
----
docker-compose down --volumes
Stopping appstack_mongo-express_1 ... done
Stopping appstack_mongo_1         ... done
Removing appstack_mongo-express_1 ... done
Removing appstack_mongo_1         ... done
Removing network appstack_backing-services
Removing volume appstack_mongo-data
----

.publish generated images
[source,bash]
----
docker-compose push
Stopping appstack_mongo-express_1 ... done
Stopping appstack_mongo_1         ... done
Removing appstack_mongo-express_1 ... done
Removing appstack_mongo_1         ... done
Removing network appstack_backing-services
Removing volume appstack_mongo-data
----

TODO: docker stack deploy...

check deployments:

. link:http://localhost:8081/[mongo express on http://localhost:8081]
. link:http://localhost:1337/[parse server app on http://localhost:1337]
. link:http://localhost/[parse client app on http://localhost]

read more:

. https://docs.docker.com/engine/swarm/stack-deploy/#set-up-a-docker-registry
